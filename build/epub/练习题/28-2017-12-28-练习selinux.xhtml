<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>28-2017-12-28-练习selinux</title>
    <link rel="stylesheet" href="../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /> 
  </head>
  <body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="selinux">
<h1>28-2017-12-28-练习selinux</h1>
<div class="section" id="id1">
<h2>练习1-selinux</h2>
<p>2、使用restore修复selinux</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>root@centos74 html<span class="o">]</span>$ ll -Z index.html
-rw-r--r--. root root unconfined_u:object_r:httpd_sys_content_t:s0 index.html
<span class="o">[</span>root@centos74 html<span class="o">]</span>$ cp index.html  /root
<span class="o">[</span>root@centos74 html<span class="o">]</span>$ ll -Z /root/index.html index.html
-rw-r--r--. root root unconfined_u:object_r:httpd_sys_content_t:s0 index.html
-rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 /root/index.html
<span class="o">[</span>root@centos74 html<span class="o">]</span>$ mv /root/index.html  .
mv: overwrite ‘./index.html’? y
<span class="o">[</span>root@centos74 html<span class="o">]</span>$ ll -Z
-rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 index.html
<span class="o">[</span>root@centos74 html<span class="o">]</span>$ restorecon -R  /var/www/html/
<span class="o">[</span>root@centos74 html<span class="o">]</span>$ ll -Z
-rw-r--r--. root root unconfined_u:object_r:httpd_sys_content_t:s0 index.html
</pre></div>
</div>
<p>3、查看semanager由那个包提供 ，并查看默认的安全上下文，添加安全上下文，删除安全上下文</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>root@centos74 html<span class="o">]</span>$ which semanage
/usr/sbin/semanage
<span class="o">[</span>root@centos74 html<span class="o">]</span>$ rpm -qf /usr/sbin/semanage
policycoreutils-python-2.5-17.1.el7.x86_64
<span class="o">[</span>root@centos74 html<span class="o">]</span>$ semanage fcontext -l
<span class="o">[</span>root@centos74 app<span class="o">]</span>$ semanage fcontext -a -t httpd_sys_content_t <span class="s1">&#39;/app(/.*)?&#39;</span>
<span class="o">[</span>root@centos74 app<span class="o">]</span>$ touch /app/11.txt
<span class="o">[</span>root@centos74 app<span class="o">]</span>$ restorecon -Rv /app
<span class="o">[</span>root@centos74 app<span class="o">]</span>$ ll -Z <span class="m">11</span>.txt
-rw-r--r--. root root unconfined_u:object_r:httpd_sys_content_t:s0 <span class="m">11</span>.txt
</pre></div>
</div>
<p>4、添加ssh的监听端口20022，并测试</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>root@centos74 app<span class="o">]</span>$ vim /etc/ssh/ssh_config
<span class="o">[</span>root@centos74 app<span class="o">]</span>$ cat /etc/ssh/ssh_config  <span class="p">|</span>grep Port
Port <span class="m">22</span>
Port <span class="m">20022</span>
<span class="o">[</span>root@centos74 app<span class="o">]</span>$ systemctl restart sshd
<span class="o">[</span>root@centos74 app<span class="o">]</span>$ netstat -tunlp <span class="p">|</span>grep sshd
tcp        <span class="m">0</span>      <span class="m">0</span> <span class="m">0</span>.0.0.0:22              <span class="m">0</span>.0.0.0:*               LISTEN      <span class="m">6252</span>/sshd
tcp6       <span class="m">0</span>      <span class="m">0</span> :::22                   :::*                    LISTEN      <span class="m">6252</span>/sshd

<span class="o">[</span>root@centos74 app<span class="o">]</span>$ semanage port -l <span class="p">|</span>grep ssh
ssh_port_t                     tcp      <span class="m">22</span>
<span class="o">[</span>root@centos74 app<span class="o">]</span>$ semanage port -a -t ssh_port_t -p tcp <span class="m">20002</span>
<span class="o">[</span>root@centos74 app<span class="o">]</span>$ semanage port -l <span class="p">|</span>grep ssh
ssh_port_t                     tcp      <span class="m">20002</span>, <span class="m">22</span>

<span class="o">[</span>root@centos74 app<span class="o">]</span>$ setenforce <span class="m">0</span>
<span class="o">[</span>root@centos74 app<span class="o">]</span>$ systemctl status sshd.service
● sshd.service - OpenSSH server daemon
Loaded: loaded <span class="o">(</span>/usr/lib/systemd/system/sshd.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
Active: active <span class="o">(</span>running<span class="o">)</span> since Thu <span class="m">2017</span>-12-28 <span class="m">12</span>:31:56 CST<span class="p">;</span> 8s ago
        Docs: man:sshd<span class="o">(</span><span class="m">8</span><span class="o">)</span>
                man:sshd_config<span class="o">(</span><span class="m">5</span><span class="o">)</span>
Main PID: <span class="m">6598</span> <span class="o">(</span>sshd<span class="o">)</span>
CGroup: /system.slice/sshd.service
                └─6598 /usr/sbin/sshd -D

Dec <span class="m">28</span> <span class="m">12</span>:31:56 centos74.magedu.com systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>: Starting OpenSSH server daemon...
Dec <span class="m">28</span> <span class="m">12</span>:31:56 centos74.magedu.com sshd<span class="o">[</span><span class="m">6598</span><span class="o">]</span>: Server listening on <span class="m">0</span>.0.0.0 port <span class="m">20022</span>.
Dec <span class="m">28</span> <span class="m">12</span>:31:56 centos74.magedu.com sshd<span class="o">[</span><span class="m">6598</span><span class="o">]</span>: Server listening on :: port <span class="m">20022</span>.
Dec <span class="m">28</span> <span class="m">12</span>:31:56 centos74.magedu.com sshd<span class="o">[</span><span class="m">6598</span><span class="o">]</span>: Server listening on <span class="m">0</span>.0.0.0 port <span class="m">22</span>.
Dec <span class="m">28</span> <span class="m">12</span>:31:56 centos74.magedu.com sshd<span class="o">[</span><span class="m">6598</span><span class="o">]</span>: Server listening on :: port <span class="m">22</span>.
Dec <span class="m">28</span> <span class="m">12</span>:31:56 centos74.magedu.com systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>: Started OpenSSH server daemon.
<span class="o">[</span>root@centos74 app<span class="o">]</span>$ setenforce <span class="m">1</span>
<span class="o">[</span>root@centos74 app<span class="o">]</span>$ systemctl status sshd.service
● sshd.service - OpenSSH server daemon
Loaded: loaded <span class="o">(</span>/usr/lib/systemd/system/sshd.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
Active: active <span class="o">(</span>running<span class="o">)</span> since Thu <span class="m">2017</span>-12-28 <span class="m">12</span>:31:56 CST<span class="p">;</span> 36s ago
        Docs: man:sshd<span class="o">(</span><span class="m">8</span><span class="o">)</span>
                man:sshd_config<span class="o">(</span><span class="m">5</span><span class="o">)</span>
Main PID: <span class="m">6598</span> <span class="o">(</span>sshd<span class="o">)</span>
CGroup: /system.slice/sshd.service
                └─6598 /usr/sbin/sshd -D

Dec <span class="m">28</span> <span class="m">12</span>:31:56 centos74.magedu.com systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>: Starting OpenSSH server daemon...
Dec <span class="m">28</span> <span class="m">12</span>:31:56 centos74.magedu.com sshd<span class="o">[</span><span class="m">6598</span><span class="o">]</span>: Server listening on <span class="m">0</span>.0.0.0 port <span class="m">20022</span>.
Dec <span class="m">28</span> <span class="m">12</span>:31:56 centos74.magedu.com sshd<span class="o">[</span><span class="m">6598</span><span class="o">]</span>: Server listening on :: port <span class="m">20022</span>.
Dec <span class="m">28</span> <span class="m">12</span>:31:56 centos74.magedu.com sshd<span class="o">[</span><span class="m">6598</span><span class="o">]</span>: Server listening on <span class="m">0</span>.0.0.0 port <span class="m">22</span>.
Dec <span class="m">28</span> <span class="m">12</span>:31:56 centos74.magedu.com sshd<span class="o">[</span><span class="m">6598</span><span class="o">]</span>: Server listening on :: port <span class="m">22</span>.
Dec <span class="m">28</span> <span class="m">12</span>:31:56 centos74.magedu.com systemd<span class="o">[</span><span class="m">1</span><span class="o">]</span>: Started OpenSSH server daemon.

<span class="o">[</span>root@centos74 app<span class="o">]</span>$ netstat -tunlp  <span class="p">|</span>grep ssh
tcp        <span class="m">0</span>      <span class="m">0</span> <span class="m">0</span>.0.0.0:22              <span class="m">0</span>.0.0.0:*               LISTEN      <span class="m">6598</span>/sshd
tcp        <span class="m">0</span>      <span class="m">0</span> <span class="m">0</span>.0.0.0:20022           <span class="m">0</span>.0.0.0:*               LISTEN      <span class="m">6598</span>/sshd
tcp6       <span class="m">0</span>      <span class="m">0</span> :::22                   :::*                    LISTEN      <span class="m">6598</span>/sshd
tcp6       <span class="m">0</span>      <span class="m">0</span> :::20022                :::*                    LISTEN      <span class="m">6598</span>/sshd
</pre></div>
</div>
<p>6、修改selinux的布尔值</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>root@centos74 app<span class="o">]</span>$ semanage boolean  -l <span class="p">|</span>grep ftp <span class="p">|</span>grep write
tftp_anon_write                <span class="o">(</span>off  ,  off<span class="o">)</span>  Allow tftp to anon write
ftpd_anon_write                <span class="o">(</span>off  ,  off<span class="o">)</span>  Allow ftpd to anon write
<span class="o">[</span>root@centos74 app<span class="o">]</span>$ setsebool  <span class="nv">ftpd_anon_write</span><span class="o">=</span><span class="m">1</span> -P
</pre></div>
</div>
<p>7、编写一个脚本完成selinux各个状态切换的脚本</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#================================================</span>
<span class="c1">#FileName   :set_selinux.sh</span>
<span class="c1">#Author     :zhaojiedi</span>
<span class="c1">#Description:</span>
<span class="c1">#DateTime   :2017-12-28 13:39:06</span>
<span class="c1">#Version    :V1.0</span>
<span class="c1">#Other      :</span>
<span class="c1">#================================================</span>

<span class="c1"># show current status</span>
<span class="nv">has_disabled</span><span class="o">=</span><span class="m">0</span>
<span class="c1">#sestatus | grep -q &quot;disabled&quot;</span>
<span class="nv">current_status</span><span class="o">=</span><span class="sb">`</span>sed -rn <span class="s1">&#39;/^SELINUX/s@^SELINUX=(.*)@\1@p&#39;</span> /etc/sysconfig/selinux<span class="sb">`</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$current_status</span><span class="s2">&quot;</span> -eq <span class="s2">&quot;disabled&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
                <span class="nv">has_disabled</span><span class="o">=</span><span class="m">1</span>
<span class="k">else</span>
                <span class="nv">has_disabled</span><span class="o">=</span><span class="m">0</span>
<span class="k">fi</span>


<span class="c1"># case</span>

<span class="k">case</span> <span class="nv">$1</span> in
enforcing<span class="o">)</span>
                setenforce <span class="m">1</span>
                sed -i <span class="s1">&#39;s@SELINUX=.*@SELINUX=enforcing@&#39;</span> /etc/sysconfig/selinux
                <span class="p">;;</span>
permissive<span class="o">)</span>
                setenforce <span class="m">0</span>
                sed -i <span class="s1">&#39;s@SELINUX=.*@SELINUX=permissive@&#39;</span> /etc/sysconfig/selinux
                <span class="p">;;</span>
disabled<span class="o">)</span>
                setenforce <span class="m">0</span>
                <span class="nv">has_disabled</span><span class="o">=</span><span class="m">1</span>
                sed -i <span class="s1">&#39;s@SELINUX=.*@SELINUX=disabled@&#39;</span> /etc/sysconfig/selinux
                <span class="p">;;</span>
*<span class="o">)</span>
                <span class="nb">echo</span> <span class="s2">&quot;Usage: set_selinux [ enforcing | permissive | disabled ]&quot;</span>
                <span class="nb">exit</span> <span class="m">1</span>
                <span class="p">;;</span>
<span class="k">esac</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$has_disabled</span><span class="s2">&quot;</span> -eq <span class="m">1</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
                <span class="nb">echo</span> -e <span class="s2">&quot;\033[31myou need to reboot \033[0m&quot;</span>
<span class="k">fi</span>
</pre></div>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>